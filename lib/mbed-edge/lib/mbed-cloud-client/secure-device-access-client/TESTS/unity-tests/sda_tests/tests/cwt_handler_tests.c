// ----------------------------------------------------------------------------
// Copyright 2017-2019 ARM Ltd.
//  
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//  
//     http://www.apache.org/licenses/LICENSE-2.0
//  
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
// ----------------------------------------------------------------------------


#include "unity_fixture.h"
#include "sda_bundle_parser.h"
#include "sda_log.h"
#include "cose.h"
#include "cose_int.h"
#include "sda_cose.h"
#include "sda_bundle_parser.h"
#include "unity_helper_macros.h"
#include "sda_trust_anchor.h"
#include "secure_device_access.h"
#include "key_config_manager.h"
#include "factory_configurator_client.h"
#include "sda_testdata.h"
#include "sda_nonce_mgr.h"
#include "sda_verification.h"
#include "test_utils.h"
#include "sda_testdata.h"
#include "test_common_utils.h"

TEST_GROUP(cwt_handler_test);

TEST_SETUP(cwt_handler_test)
{
    fcc_tst_setup();
    TEST_SKIP_EXECUTION_ON_FAILURE();

}

TEST_TEAR_DOWN(cwt_handler_test)
{
    fcc_tst_tear_down();
    TEST_SKIP_EXECUTION_ON_FAILURE();
}


/**
12: "turn-led-on",
25: {1: {-3: h'319499C5629ACA8AE5266E9ACA486E82C006CB9886E13B337A8625F517EFB0B5', 1: 2, -2: h'98351F31DE9529E524504027A7BDAD5081E6B61D96DE3C6F6051C82EB2920089', -1: 1}}
2: "Dummy_sub"
3: "device-id:abcdef12-3456-789a-bcde-f123456789ab"
4: 4102358399
5: 1508716800
6: 1509976559
1: "FC:DB:6B:A9:27:63:6C:26:F9:F7:D5:75:BF:82:EF:C2:6E:F1:58:C9"
7: h'015F919DCE82507B9D48ABF700000000'}
*/
const uint8_t cwt_test1[] = { 0xA9, 0x0C, 0x78, 0x33, 0x20, 0x64, 0x65, 0x6D, 0x6F, 0x5F, 0x63, 0x61, 0x6C, 0x6C, 0x62, 0x61, 0x63, 0x6B, 0x5F
, 0x72, 0x65, 0x61, 0x64, 0x5F, 0x64, 0x61, 0x74, 0x61, 0x20, 0x20, 0x20, 0x64, 0x65, 0x6D, 0x6F, 0x5F, 0x63, 0x61
, 0x6C, 0x6C, 0x62, 0x61, 0x63, 0x6B, 0x5F, 0x63, 0x6F, 0x6E, 0x66, 0x69, 0x67, 0x75, 0x72, 0x65, 0x20, 0x18, 0x19
, 0xA1, 0x01, 0xA4, 0x22, 0x58, 0x20, 0x31, 0x94, 0x99, 0xC5, 0x62, 0x9A, 0xCA, 0x8A, 0xE5, 0x26, 0x6E, 0x9A, 0xCA
, 0x48, 0x6E, 0x82, 0xC0, 0x06, 0xCB, 0x98, 0x86, 0xE1, 0x3B, 0x33, 0x7A, 0x86, 0x25, 0xF5, 0x17, 0xEF, 0xB0, 0xB5
, 0x01, 0x02, 0x21, 0x58, 0x20, 0x98, 0x35, 0x1F, 0x31, 0xDE, 0x95, 0x29, 0xE5, 0x24, 0x50, 0x40, 0x27, 0xA7, 0xBD
, 0xAD, 0x50, 0x81, 0xE6, 0xB6, 0x1D, 0x96, 0xDE, 0x3C, 0x6F, 0x60, 0x51, 0xC8, 0x2E, 0xB2, 0x92, 0x00, 0x89, 0x20
, 0x01, 0x02, 0x69, 0x44, 0x75, 0x6D, 0x6D, 0x79, 0x5F, 0x73, 0x75, 0x62, 0x03, 0x81, 0x78, 0x27, 0x69, 0x64, 0x3A
,0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x31, 0x32, 0x2D, 0x33, 0x34, 0x35, 0x36, 0x2D, 0x37, 0x38, 0x39, 0x61, 0x2D,
0x62
, 0x63, 0x64, 0x65, 0x2D, 0x66, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x61, 0x62, 0x04, 0x1A, 0xF4
, 0x85, 0x05, 0x7F, 0x05, 0x1A, 0x59, 0xED, 0x31, 0x00, 0x06, 0x1A, 0x5A, 0x00, 0x69, 0xEF, 0x01, 0x78, 0x3B, 0x46
, 0x43, 0x3A, 0x44, 0x42, 0x3A, 0x36, 0x42, 0x3A, 0x41, 0x39, 0x3A, 0x32, 0x37, 0x3A, 0x36, 0x33, 0x3A, 0x36, 0x43
, 0x3A, 0x32, 0x36, 0x3A, 0x46, 0x39, 0x3A, 0x46, 0x37, 0x3A, 0x44, 0x35, 0x3A, 0x37, 0x35, 0x3A, 0x42, 0x46, 0x3A
, 0x38, 0x32, 0x3A, 0x45, 0x46, 0x3A, 0x43, 0x32, 0x3A, 0x36, 0x45, 0x3A, 0x46, 0x31, 0x3A, 0x35, 0x38, 0x3A, 0x43
, 0x39, 0x07, 0x50, 0x01, 0x5F, 0x91, 0x9D, 0xCE, 0x82, 0x50, 0x7B, 0x9D, 0x48, 0xAB, 0xF7, 0x00, 0x00, 0x00,
0x00

};

/**
{// RFC input test (test2) (https://tools.ietf.org/html/draft-ietf-ace-cbor-web-token-08)
/ iss / 1: "coap://as.example.com",
/ aud / 3: "coap://light.example.com",
/ exp / 4: 1444064944,
/ nbf / 5: 1443944944,
/ iat / 6: 1443944944,
/ cti / 7: h'0b71'
}
*/
const uint8_t cwt_test2[] = {
    0xA6, 0x01, 0x75, 0x63, 0x6F, 0x61, 0x70, 0x3A, 0x2F, 0x2F, 0x61, 0x73, 0x2E, 0x65, 0x78, 0x61, 0x6D, 0x70, 0x6C
    , 0x65, 0x2E, 0x63, 0x6F, 0x6D, 0x03, 0x81, 0x78, 0x18, 0x63, 0x6F, 0x61, 0x70, 0x3A, 0x2F, 0x2F, 0x6C, 0x69, 0x67, 0x68
    , 0x74, 0x2E, 0x65, 0x78, 0x61, 0x6D, 0x70, 0x6C, 0x65, 0x2E, 0x63, 0x6F, 0x6D, 0x04, 0x1A, 0x56, 0x12, 0xAE, 0xB0
    , 0x05, 0x1A, 0x56, 0x10, 0xD9, 0xF0, 0x06, 0x1A, 0x56, 0x10, 0xD9, 0xF0, 0x07, 0x42, 0x0B, 0x71
};


/**
{// RFC input test (test3) with POP inside (http://self-issued.info/docs/draft-ietf-ace-cwt-proof-of-possession-00.html)
1: "https://server.example.com",
3: "https://client.example.org",
4": 1361398824,
25:{
"COSE_Key":{
"kty": "EC",
"crv": "P-256",
"x": "18wHLeIgW9wVN6VD1Txgpqy2LszYkMf6J8njVAibvhM",
"y": "-V4dS4UaLMgP_4fY4j8ir7cl1TXlFdAgcx55o7TkcSA"
}
}
}
*/

// This cwt is currently commented out since it uses strings as map keys and we only support numbers
/*
const uint8_t cwt_test3[] = {
0xA4, 0x01, 0x78, 0x1A, 0x68, 0x74, 0x74, 0x70, 0x73, 0x3A, 0x2F, 0x2F, 0x73, 0x65, 0x72, 0x76, 0x65, 0x72, 0x2E
, 0x65, 0x78, 0x61, 0x6D, 0x70, 0x6C, 0x65, 0x2E, 0x63, 0x6F, 0x6D, 0x03, 0x78, 0x1A, 0x68, 0x74, 0x74, 0x70, 0x73
, 0x3A, 0x2F, 0x2F, 0x63, 0x6C, 0x69, 0x65, 0x6E, 0x74, 0x2E, 0x65, 0x78, 0x61, 0x6D, 0x70, 0x6C, 0x65, 0x2E, 0x6F
, 0x72, 0x67, 0x04, 0x1A, 0x51, 0x25, 0x4C, 0x28, 0x18, 0x19, 0xA1, 0x68, 0x43, 0x4F, 0x53, 0x45, 0x5F, 0x4B, 0x65
, 0x79, 0xA4, 0x63, 0x6B, 0x74, 0x79, 0x62, 0x45, 0x43, 0x63, 0x63, 0x72, 0x76, 0x65, 0x50, 0x2D, 0x32, 0x35, 0x36
, 0x61, 0x78, 0x78, 0x2B, 0x31, 0x38, 0x77, 0x48, 0x4C, 0x65, 0x49, 0x67, 0x57, 0x39, 0x77, 0x56, 0x4E, 0x36, 0x56
, 0x44, 0x31, 0x54, 0x78, 0x67, 0x70, 0x71, 0x79, 0x32, 0x4C, 0x73, 0x7A, 0x59, 0x6B, 0x4D, 0x66, 0x36, 0x4A, 0x38
, 0x6E, 0x6A, 0x56, 0x41, 0x69, 0x62, 0x76, 0x68, 0x4D, 0x61, 0x79, 0x78, 0x2B, 0x2D, 0x56, 0x34, 0x64, 0x53, 0x34
, 0x55, 0x61, 0x4C, 0x4D, 0x67, 0x50, 0x5F, 0x34, 0x66, 0x59, 0x34, 0x6A, 0x38, 0x69, 0x72, 0x37, 0x63, 0x6C, 0x31
, 0x54, 0x58, 0x6C, 0x46, 0x64, 0x41, 0x67, 0x63, 0x78, 0x35, 0x35, 0x6F, 0x37, 0x54, 0x6B, 0x63, 0x53, 0x41
};
*/

typedef struct cwt_test_obj {
    const uint8_t *cwt_blob;
    size_t blob_size;
    cwt_claims_s cwt_output;
} cwt_test_vector_s;

uint8_t test_cti_data_1[16] = { 0x01, 0x5F, 0x91, 0x9D, 0xCE, 0x82, 0x50, 0x7B, 0x9D, 0x48, 0xAB, 0xF7, 0x00, 0x00, 0x00, 0x00 };
uint8_t test_cti_data_2[2] = { 0x0b, 0x71 };

uint64_t audience_array[] = { 0x81, 0x78, 0x27, 0x69, 0x64, 0x3A, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x31, 0x32, 0x2D, 0x33, 0x34, 0x35, 0x36
, 0x2D, 0x37, 0x38, 0x39, 0x61, 0x2D, 0x62, 0x63, 0x64, 0x65, 0x2D, 0x66, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37
, 0x38, 0x39, 0x61, 0x62 };



cwt_test_vector_s cwt_test_vector[] = {
    {
        .cwt_blob = cwt_test1,
        .blob_size = sizeof(cwt_test1),
        .cwt_output.issuer_data = NULL,
        .cwt_output.audience_array_ptr = NULL,// the audience data saved hardcoded in the test (uint8_t*)"id:abcdef12-3456-789a-bcde-f123456789ab"
        .cwt_output.audience_array_size = 0,
        .cwt_output.exp = 4102358399,
        .cwt_output.nbf = 1508716800,
        .cwt_output.iat = 1509976559,
        .cwt_output.scope_data = (uint8_t*)" demo_callback_read_data   demo_callback_configure ",
        .cwt_output.cti_data = test_cti_data_1,
        .cwt_output.cti_data_size = 16,
        .cwt_output.pk = {
    0x04, 0x98, 0x35, 0x1F, 0x31, 0xDE, 0x95, 0x29,0xE5, 0x24, 0x50, 0x40, 0x27, 0xA7, 0xBD, 0xAD, 0x50,
    0x81, 0xE6, 0xB6, 0x1D, 0x96, 0xDE, 0x3C, 0x6F, 0x60, 0x51, 0xC8, 0x2E, 0xB2, 0x92, 0x00, 0x89, 0x31,
    0x94, 0x99, 0xC5, 0x62, 0x9A, 0xCA, 0x8A, 0xE5, 0x26, 0x6E, 0x9A, 0xCA, 0x48, 0x6E, 0x82, 0xC0, 0x06,
    0xCB, 0x98, 0x86, 0xE1, 0x3B, 0x33, 0x7A, 0x86, 0x25, 0xF5, 0x17, 0xEF, 0xB0, 0xB5
},
.cwt_output.pk_size = 65
    },
    {
        .cwt_blob = cwt_test2,
        .blob_size = sizeof(cwt_test2),
        .cwt_output.issuer_data = (uint8_t*)"coap://as.example.com",
        .cwt_output.audience_array_ptr = NULL,// the audience data saved hardcoded in the test (uint8_t*)"coap://light.example.com"
        .cwt_output.audience_array_size = 0,
        .cwt_output.exp = 1444064944,
        .cwt_output.nbf = 1443944944,
        .cwt_output.iat = 1443944944,
        .cwt_output.scope_data = NULL,
        .cwt_output.cti_data = test_cti_data_2,
        .cwt_output.cti_data_size = 2,
        .cwt_output.pk = { 0 },
        .cwt_output.pk_size = 0
    }
};

#define TEST_VECTOR_SIZE UNITY_ARRAY_LENGTH(cwt_test_vector)

TEST(cwt_handler_test, cwt_parse)
{
    sda_status_e sda_status = SDA_STATUS_SUCCESS;
    cwt_claims_s cwt_out;
    uint8_t i;
    bool status = false;
    //char audience_1[] = "id:abcdef12-3456-789a-bcde-f123456789ab";
    uint8_t cbor_audience_1[] = {
        0x81,0x78, 0x27, 0x69, 0x64, 0x3A, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x31, 0x32, 0x2D, 0x33, 0x34, 0x35, 0x36, 0x2D,
        0x37, 0x38, 0x39, 0x61, 0x2D, 0x62, 0x63, 0x64, 0x65, 0x2D, 0x66, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
        0x39, 0x61, 0x62 };
    // char audience_2[] = "coap://light.example.com";
    uint8_t cbor_audience_2[] = {
        0x81, 0x78, 0x18, 0x63, 0x6F, 0x61, 0x70, 0x3A, 0x2F, 0x2F, 0x6C, 0x69, 0x67, 0x68, 0x74, 0x2E, 0x65, 0x78, 0x61, 0x6D,
        0x70, 0x6C, 0x65, 0x2E, 0x63, 0x6F, 0x6D
    };
    CborParser parser;
    CborValue expected_audience;
    CborError cbor_error = CborNoError;
    uint8_t *expected_audience_array = NULL;
    size_t expected_audience_array_size = 0;
    uint8_t *cwt_audience_array = NULL;
    size_t cwt_audience_array_size = 0;

    for (i = 0; i < TEST_VECTOR_SIZE; i++) {
        memset(&expected_audience, 0, sizeof(CborValue));
        if (i == 0) {
            expected_audience_array = &cbor_audience_1;
            expected_audience_array_size = sizeof(cbor_audience_1);
        } else {
            expected_audience_array = &cbor_audience_2;
            expected_audience_array_size = sizeof(cbor_audience_2);
        }

        if (cwt_test_vector[i].cwt_output.issuer_data != NULL) {
            cwt_test_vector[i].cwt_output.issuer_data_size = strlen((char*)cwt_test_vector[i].cwt_output.issuer_data);
        } else {
            cwt_test_vector[i].cwt_output.issuer_data_size = 0;
        }
        if (cwt_test_vector[i].cwt_output.scope_data != NULL) {
            cwt_test_vector[i].cwt_output.scope_data_size = strlen((char*)cwt_test_vector[i].cwt_output.scope_data);
        } else {
            cwt_test_vector[i].cwt_output.scope_data_size = 0;
        }


        SDA_LOG_INFO("\nINDEX of iteration %d\n", (int)i);
        memset(&cwt_out, 0, sizeof(cwt_out));

        sda_status = sda_cwt_parse_tiny(cwt_test_vector[i].cwt_blob, cwt_test_vector[i].blob_size, &cwt_out);
        TEST_ASSERT(sda_status == SDA_STATUS_SUCCESS);
        TEST_ASSERT_EQUAL_UINT32_MESSAGE(cwt_test_vector[i].cwt_output.scope_data_size, cwt_out.scope_data_size, "Scope size does not match");
        TEST_ASSERT_EQUAL_UINT32_MESSAGE(cwt_test_vector[i].cwt_output.cti_data_size, cwt_out.cti_data_size, "Cti size does not match");

        if (cwt_test_vector[i].cwt_output.issuer_data_size != 0) {
            //FIXME: fix after Issue fixing
            TEST_ASSERT_EQUAL_UINT32_MESSAGE(cwt_test_vector[i].cwt_output.issuer_data_size, cwt_out.issuer_data_size, "Issuer size does not match");
            TEST_ASSERT_EQUAL_MEMORY(cwt_test_vector[i].cwt_output.issuer_data, cwt_out.issuer_data, cwt_out.issuer_data_size);
        }

        if (cwt_test_vector[i].cwt_output.scope_data_size != 0) {
            TEST_ASSERT_EQUAL_MEMORY(cwt_test_vector[i].cwt_output.scope_data, cwt_out.scope_data, cwt_out.scope_data_size);
        }

        //Check audience type
        TEST_ASSERT_EQUAL_INT(expected_audience_array_size, cwt_out.audience_array_size);

        TEST_ASSERT_EQUAL_MEMORY(cwt_out.audience_array_ptr, expected_audience_array, expected_audience_array_size);
        //Check the rest of the cwt parameters
        TEST_ASSERT_EQUAL_MEMORY(&cwt_test_vector[i].cwt_output.exp, &cwt_out.exp, sizeof(cwt_out.exp));
        TEST_ASSERT_EQUAL_MEMORY(&cwt_test_vector[i].cwt_output.nbf, &cwt_out.nbf, sizeof(cwt_out.nbf));
        TEST_ASSERT_EQUAL_MEMORY(&cwt_test_vector[i].cwt_output.iat, &cwt_out.iat, sizeof(cwt_out.iat));
        TEST_ASSERT_EQUAL_INT(cwt_test_vector[i].cwt_output.pk_size, cwt_out.pk_size);
        TEST_ASSERT_EQUAL_MEMORY(&cwt_test_vector[i].cwt_output.pk, &(cwt_out.pk), sizeof(cwt_out.pk));

    }

}

TEST(cwt_handler_test, cose_validate_with_provided_pk)
{
    sda_status_e sda_status = SDA_STATUS_SUCCESS;

    sda_status = sda_cose_validate_with_raw_pk(g_lcd_display_access_token, sizeof(g_lcd_display_access_token), g_trust_anchor + 26, 65);
    TEST_ASSERT_EQUAL_INT(SDA_STATUS_SUCCESS, sda_status);
}

TEST(cwt_handler_test, token_validation)
{
    sda_status_e sda_status = SDA_STATUS_SUCCESS;
    sda_status_e expected_sda_status = SDA_STATUS_INTERNAL_TOKEN_EXPIRATION_ERROR;
    sda_message_data_s bundle_data;
    cwt_claims_s cwt_out;
    int test_index = 0;

    //{12: "lcd-display-hello_world", 2: "demo", 3: "endpoint-name:dev1", 4: 1451637099, 5: 1420101099, 6: 1420101099, 1: "6F:CF:35:29:1E:DA:F2:E6:BF:20:33:ED:3F:26:02:95:75:8E:6E:1B", 7: h'015FB59EEE11507B9D48ADB200000000', 25: {1: {-3: h'529DFDC507A87CD533E67DEE1928D411361A5EC1991B227C026B9832F6F67C39', 1: 2, -2: 
    const uint8_t expired_token[] = { 0xA9, 0x0C, 0x77, 0x6C, 0x63, 0x64, 0x2D, 0x64, 0x69, 0x73, 0x70, 0x6C, 0x61, 0x79, 0x2D, 0x68, 0x65, 0x6C, 0x6C
        , 0x6F, 0x5F, 0x77, 0x6F, 0x72, 0x6C, 0x64, 0x02, 0x64, 0x64, 0x65, 0x6D, 0x6F, 0x03, 0x72, 0x65, 0x6E, 0x64, 0x70
        , 0x6F, 0x69, 0x6E, 0x74, 0x2D, 0x6E, 0x61, 0x6D, 0x65, 0x3A, 0x64, 0x65, 0x76, 0x31, 0x04, 0x1A, 0x56, 0x86, 0x39
        , 0x6B, 0x05, 0x1A, 0x54, 0xA5, 0x05, 0xEB, 0x06, 0x1A, 0x54, 0xA5, 0x05, 0xEB, 0x01, 0x78, 0x3B, 0x36, 0x46, 0x3A
        , 0x43, 0x46, 0x3A, 0x33, 0x35, 0x3A, 0x32, 0x39, 0x3A, 0x31, 0x45, 0x3A, 0x44, 0x41, 0x3A, 0x46, 0x32, 0x3A, 0x45
        , 0x36, 0x3A, 0x42, 0x46, 0x3A, 0x32, 0x30, 0x3A, 0x33, 0x33, 0x3A, 0x45, 0x44, 0x3A, 0x33, 0x46, 0x3A, 0x32, 0x36
        , 0x3A, 0x30, 0x32, 0x3A, 0x39, 0x35, 0x3A, 0x37, 0x35, 0x3A, 0x38, 0x45, 0x3A, 0x36, 0x45, 0x3A, 0x31, 0x42, 0x07
        , 0x50, 0x01, 0x5F, 0xB5, 0x9E, 0xEE, 0x11, 0x50, 0x7B, 0x9D, 0x48, 0xAD, 0xB2, 0x00, 0x00, 0x00, 0x00, 0x18, 0x19
        , 0xA1, 0x01, 0xA4, 0x22, 0x58, 0x20, 0x52, 0x9D, 0xFD, 0xC5, 0x07, 0xA8, 0x7C, 0xD5, 0x33, 0xE6, 0x7D, 0xEE, 0x19
        , 0x28, 0xD4, 0x11, 0x36, 0x1A, 0x5E, 0xC1, 0x99, 0x1B, 0x22, 0x7C, 0x02, 0x6B, 0x98, 0x32, 0xF6, 0xF6, 0x7C, 0x39
        , 0x01, 0x02, 0x21, 0x58, 0x20, 0x7F, 0x5B, 0x0F, 0x9B, 0xB0, 0xA8, 0x96, 0x8D, 0x1F, 0x3A, 0x43, 0x95, 0x17, 0x0E
        , 0x1E, 0x79, 0xCC, 0x44, 0x62, 0x17, 0xBC, 0x9B, 0x35, 0x59, 0xBB, 0x1D, 0xF7, 0xBB, 0x70, 0x2C, 0x88, 0xA0, 0x20
        , 0x01 };

    //{12: "lcd-display-hello_world", 25: {1: {-3: h'529DFDC507A87CD533E67DEE1928D411361A5EC1991B227C026B9832F6F67C39', 1: 2, -2: h'7F5B0F9BB0A8968D1F3A4395170E1E79CC446217BC9B3559BB1DF7BB702C88A0', -1: 1}}, 2: "demo", 3: "endpoint-name:dev1", 4: 2524638699, 5: 1893486699, 6: 1420101099, 1: "6F:CF:35:29:1E:DA:F2:E6:BF:20:33:ED:3F:26:02:95:75:8E:6E:1B", 7: h'015FB59EEE11507B9D48ADB200000000'}
    const uint8_t not_valid_token[] = { 0xA9, 0x0C, 0x77, 0x6C, 0x63, 0x64, 0x2D, 0x64, 0x69, 0x73, 0x70, 0x6C, 0x61, 0x79, 0x2D, 0x68,
        0x65, 0x6C, 0x6C, 0x6F, 0x5F, 0x77, 0x6F, 0x72, 0x6C, 0x64, 0x18, 0x19, 0xA1, 0x01, 0xA4, 0x22,
        0x58, 0x20, 0x52, 0x9D, 0xFD, 0xC5, 0x07, 0xA8, 0x7C, 0xD5, 0x33, 0xE6, 0x7D, 0xEE, 0x19, 0x28,
        0xD4, 0x11, 0x36, 0x1A, 0x5E, 0xC1, 0x99, 0x1B, 0x22, 0x7C, 0x02, 0x6B, 0x98, 0x32, 0xF6, 0xF6,
        0x7C, 0x39, 0x01, 0x02, 0x21, 0x58, 0x20, 0x7F, 0x5B, 0x0F, 0x9B, 0xB0, 0xA8, 0x96, 0x8D, 0x1F,
        0x3A, 0x43, 0x95, 0x17, 0x0E, 0x1E, 0x79, 0xCC, 0x44, 0x62, 0x17, 0xBC, 0x9B, 0x35, 0x59, 0xBB,
        0x1D, 0xF7, 0xBB, 0x70, 0x2C, 0x88, 0xA0, 0x20, 0x01, 0x02, 0x64, 0x64, 0x65, 0x6D, 0x6F, 0x03,
        0x72, 0x65, 0x6E, 0x64, 0x70, 0x6F, 0x69, 0x6E, 0x74, 0x2D, 0x6E, 0x61, 0x6D, 0x65, 0x3A, 0x64,
        0x65, 0x76, 0x31, 0x04, 0x1A, 0x96, 0x7A, 0xED, 0xEB, 0x05, 0x1A, 0x70, 0xDC, 0x50, 0x6B, 0x06,
        0x1A, 0x54, 0xA5, 0x05, 0xEB, 0x01, 0x78, 0x3B, 0x36, 0x46, 0x3A, 0x43, 0x46, 0x3A, 0x33, 0x35,
        0x3A, 0x32, 0x39, 0x3A, 0x31, 0x45, 0x3A, 0x44, 0x41, 0x3A, 0x46, 0x32, 0x3A, 0x45, 0x36, 0x3A,
        0x42, 0x46, 0x3A, 0x32, 0x30, 0x3A, 0x33, 0x33, 0x3A, 0x45, 0x44, 0x3A, 0x33, 0x46, 0x3A, 0x32,
        0x36, 0x3A, 0x30, 0x32, 0x3A, 0x39, 0x35, 0x3A, 0x37, 0x35, 0x3A, 0x38, 0x45, 0x3A, 0x36, 0x45,
        0x3A, 0x31, 0x42, 0x07, 0x50, 0x01, 0x5F, 0xB5, 0x9E, 0xEE, 0x11, 0x50, 0x7B, 0x9D, 0x48, 0xAD,
        0xB2, 0x00, 0x00, 0x00, 0x00 };


    for (test_index = 0; test_index < 2; test_index++) {

        if (test_index == 1) {
            expected_sda_status = SDA_STATUS_SUCCESS;
            pal_osSetTime(0);
        }

        memset(&cwt_out, 0, sizeof(cwt_out));

        //Parse access token to cwt data structure
        sda_status = sda_cwt_parse_tiny(expired_token, sizeof(expired_token), &cwt_out);
        TEST_ASSERT(sda_status == SDA_STATUS_SUCCESS);

        // Verify the nonce, signature, UUID, etc.
        sda_status = sda_token_expiration_verify(&cwt_out);
        TEST_ASSERT_EQUAL_INT(expected_sda_status, sda_status);

        memset(&cwt_out, 0, sizeof(cwt_out));


        //Parse access token to cwt data structure
        sda_status = sda_cwt_parse_tiny(not_valid_token, sizeof(not_valid_token), &cwt_out);
        TEST_ASSERT(sda_status == SDA_STATUS_SUCCESS);


        // Verify the nonce, signature, UUID, etc.
        sda_status = sda_token_expiration_verify(&cwt_out);
        TEST_ASSERT_EQUAL_INT(expected_sda_status, sda_status);

    }

    pal_osSetTime(g_current_time);
}

TEST_GROUP_RUNNER(cwt_handler_test)
{
    RUN_TEST_CASE(cwt_handler_test, cwt_parse);
    RUN_TEST_CASE(cwt_handler_test, cose_validate_with_provided_pk);
    RUN_TEST_CASE(cwt_handler_test, token_validation);
}
